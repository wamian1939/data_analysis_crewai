"""
Crew ç¼–æ’å±‚ - å®šä¹‰å¤š Agent ä»»åŠ¡æµç¨‹
åè°ƒ DataEngineerã€BizAnalyst å’Œ Reporter å®Œæˆæ•°æ®åˆ†æä»»åŠ¡
"""
from crewai import Crew, Task, Process
from agents.data_engineer import create_data_engineer
from agents.biz_analyst import create_biz_analyst
from agents.reporter import create_reporter


class DataAnalysisCrew:
    """æ•°æ®åˆ†æ Crew - åè°ƒå¤šä¸ª Agent å®Œæˆåˆ†æä»»åŠ¡"""
    
    def __init__(self):
        """åˆå§‹åŒ– Agents"""
        self.data_engineer = create_data_engineer()
        self.biz_analyst = create_biz_analyst()
        self.reporter = create_reporter()
    
    def create_tasks(self, question: str) -> list[Task]:
        """
        åˆ›å»ºä»»åŠ¡æµç¨‹
        
        å‚æ•°:
            question: ç”¨æˆ·çš„ä¸šåŠ¡é—®é¢˜
        
        è¿”å›:
            ä»»åŠ¡åˆ—è¡¨
        """
        # ä»»åŠ¡ 1ï¼šæ•°æ®æå–ï¼ˆDataEngineerï¼‰
        task_extract_data = Task(
            description=f"""
            ç”¨æˆ·é—®é¢˜ï¼š{question}
            
            âš ï¸ é‡è¦ï¼šä½ å¿…é¡»ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å®é™…æ•°æ®ï¼Œä¸èƒ½å‡­ç©ºå›ç­”ï¼
            
            ä½ çš„ä»»åŠ¡ï¼ˆå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼‰ï¼š
            1. é¦–å…ˆï¼Œä½¿ç”¨ get_database_schema() æŸ¥çœ‹æ•°æ®åº“æœ‰å“ªäº›è¡¨å’Œå­—æ®µ
            2. ç„¶åï¼Œä½¿ç”¨ nl2sql() å·¥å…·å°†é—®é¢˜è½¬æ¢ä¸º SQL æŸ¥è¯¢
            3. æœ€åï¼Œä½¿ç”¨ sql_query_md() å·¥å…·æ‰§è¡Œ SQL æŸ¥è¯¢
            4. è¿”å› Markdown æ ¼å¼çš„**çœŸå®æ•°æ®è¡¨æ ¼**
            
            â›” ç¦æ­¢è¡Œä¸ºï¼š
            - ä¸èƒ½ä¸æŸ¥è¯¢æ•°æ®åº“å°±ç›´æ¥å›ç­”é—®é¢˜
            - ä¸èƒ½ç¼–é€ è™šå‡æ•°æ®
            - ä¸èƒ½ç»™å‡ºæ²¡æœ‰æ•°æ®æ”¯æ’‘çš„é€šç”¨å»ºè®®
            
            å¦‚æœé—®é¢˜æ¶‰åŠ"é”€å”®"ã€"è®¢å•"ã€"å‘˜å·¥"ç­‰ï¼š
            - å…ˆç”¨ get_csv_schema() æŸ¥çœ‹ CSV æ–‡ä»¶æ˜¯å¦æœ‰ç›¸å…³æ•°æ®
            - å¦‚æœæœ‰ï¼Œç”¨ csv_query() æŸ¥è¯¢ CSV æ•°æ®
            - å¦‚æœæ²¡æœ‰ï¼ŒæŸ¥è¯¢æ•°æ®åº“
            
            å¦‚æœé—®é¢˜æ¶‰åŠ"å®¢æˆ·"ã€"è‰ºäºº"ã€"ä¸“è¾‘"ã€"æµæ´¾"ï¼š
            - ç›´æ¥æŸ¥è¯¢ MySQL æ•°æ®åº“
            
            å¿…é¡»è¿”å›ï¼šåŒ…å«å®é™…æŸ¥è¯¢ç»“æœçš„ Markdown è¡¨æ ¼
            """,
            agent=self.data_engineer,
            expected_output="åŒ…å«çœŸå®æ•°æ®çš„ Markdown æ ¼å¼æŸ¥è¯¢ç»“æœè¡¨æ ¼ï¼ˆä¸èƒ½æ˜¯ç©ºè¡¨æ ¼æˆ–ç¼–é€ çš„æ•°æ®ï¼‰"
        )
        
        # ä»»åŠ¡ 2ï¼šä¸šåŠ¡æ´å¯Ÿï¼ˆBizAnalystï¼‰
        task_analyze_insights = Task(
            description="""
            åŸºäºä¸Šä¸€æ­¥çš„**çœŸå®æ•°æ®è¡¨æ ¼**ï¼Œæå–ä¸šåŠ¡æ´å¯Ÿã€‚
            
            âš ï¸ é‡è¦ï¼šä½ çš„åˆ†æå¿…é¡»å®Œå…¨åŸºäºä¸Šä¸€æ­¥æŸ¥è¯¢åˆ°çš„çœŸå®æ•°æ®ï¼
            
            ä½ çš„ä»»åŠ¡ï¼š
            1. ä»”ç»†æŸ¥çœ‹ä¸Šä¸€æ­¥è¿”å›çš„æ•°æ®è¡¨æ ¼
            2. ä½¿ç”¨ summarize_table å·¥å…·åˆ†æè¿™ä¸ªè¡¨æ ¼
            3. è¯†åˆ«æ•°æ®ä¸­çš„ TOP é¡¹ã€è¶‹åŠ¿å’Œå…³é”®æ¨¡å¼
            4. æç‚¼ 2-3 æ¡**æœ‰æ•°æ®æ”¯æ’‘**çš„ä¸šåŠ¡æ´å¯Ÿ
            5. å¦‚æœéœ€è¦ï¼Œä½¿ç”¨ calculate_kpi å·¥å…·è®¡ç®— KPI
            
            â›” ç¦æ­¢è¡Œä¸ºï¼š
            - ä¸èƒ½å‡­ç©ºç¼–é€ æ´å¯Ÿ
            - ä¸èƒ½è¯´æ•°æ®è¡¨æ ¼ä¸­æ²¡æœ‰çš„å†…å®¹
            - æ´å¯Ÿå¿…é¡»å¼•ç”¨å…·ä½“çš„æ•°æ®ï¼ˆæ•°å­—ã€æ¯”ä¾‹ç­‰ï¼‰
            
            è¾“å‡ºæ ¼å¼ï¼š
            - æ¯æ¡æ´å¯Ÿåº”è¯¥æ¸…æ™°ã€å…·ä½“ã€å¼•ç”¨çœŸå®æ•°æ®
            - ä¾‹å¦‚ï¼š"USA å®¢æˆ·æ¶ˆè´¹ $1,234ï¼Œå æ¯” 22%"ï¼ˆæœ‰å…·ä½“æ•°å­—ï¼‰
            - ä¸è¦è¯´æ³›æ³›çš„é€šç”¨å»ºè®®
            """,
            agent=self.biz_analyst,
            expected_output="2-3 æ¡åŸºäºçœŸå®æ•°æ®çš„å…³é”®ä¸šåŠ¡æ´å¯Ÿï¼ˆå¿…é¡»åŒ…å«å…·ä½“æ•°å­—ï¼‰",
            context=[task_extract_data]  # ä¾èµ–ç¬¬ä¸€ä¸ªä»»åŠ¡çš„è¾“å‡º
        )
        
        # ä»»åŠ¡ 3ï¼šç”ŸæˆæŠ¥å‘Šï¼ˆReporterï¼‰
        task_generate_report = Task(
            description=f"""
            åŸºäºå‰ä¸¤æ­¥çš„**çœŸå®æ•°æ®å’Œæ´å¯Ÿ**ï¼Œç”Ÿæˆä¸€ä»½å®Œæ•´çš„ç®¡ç†å±‚æŠ¥å‘Šã€‚
            
            âš ï¸ é‡è¦ï¼šæŠ¥å‘Šå¿…é¡»å®Œå…¨åŸºäºå‰ä¸¤æ­¥çš„çœŸå®æ•°æ®ï¼Œä¸èƒ½æ·»åŠ ä»»ä½•ç¼–é€ çš„å†…å®¹ï¼
            
            æŠ¥å‘Šç»“æ„ï¼ˆä¸¥æ ¼éµå®ˆï¼‰ï¼š
            # æ•°æ®åˆ†ææŠ¥å‘Š
            
            ## ğŸ“‹ åˆ†æé—®é¢˜
            {question}
            
            ## ğŸ“Š æ•°æ®æŸ¥è¯¢ç»“æœ
            [å®Œæ•´æ’å…¥ç¬¬ä¸€æ­¥çš„æ•°æ®è¡¨æ ¼ - å¿…é¡»ä¿ç•™åŸå§‹æ•°æ®]
            
            ## ğŸ’¡ å…³é”®ä¸šåŠ¡æ´å¯Ÿ
            [å®Œæ•´æ’å…¥ç¬¬äºŒæ­¥çš„æ´å¯Ÿ - å¿…é¡»åŒ…å«å…·ä½“æ•°å­—]
            
            ## ğŸ¯ å»ºè®®ä¸è¡ŒåŠ¨é¡¹
            åŸºäºä»¥ä¸Š**çœŸå®æ•°æ®**å’Œæ´å¯Ÿï¼Œç»™å‡º 2-3 æ¡å¯æ“ä½œçš„å»ºè®®ã€‚
            å»ºè®®å¿…é¡»é’ˆå¯¹æ•°æ®ä¸­å‘ç°çš„å…·ä½“é—®é¢˜ï¼Œä¸èƒ½æ˜¯æ³›æ³›è€Œè°ˆã€‚
            
            â›” ç¦æ­¢è¡Œä¸ºï¼š
            - ä¸èƒ½åˆ é™¤æˆ–ä¿®æ”¹ç¬¬ä¸€æ­¥çš„æ•°æ®è¡¨æ ¼
            - ä¸èƒ½åˆ é™¤æˆ–ä¿®æ”¹ç¬¬äºŒæ­¥çš„æ´å¯Ÿ
            - ä¸èƒ½æ·»åŠ æ•°æ®ä¸­æ²¡æœ‰çš„å†…å®¹
            - å»ºè®®å¿…é¡»åŸºäºæ•°æ®ï¼Œä¸èƒ½å‡­ç©ºæƒ³è±¡
            
            è¦æ±‚ï¼š
            - ä½¿ç”¨æ¸…æ™°çš„ Markdown æ ¼å¼
            - ä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§
            - è¯­è¨€ç®€æ´ä¸“ä¸šï¼Œé¢å‘ç®¡ç†å±‚
            - æ‰€æœ‰å»ºè®®å¿…é¡»å¼•ç”¨å…·ä½“çš„æ•°æ®å‘ç°
            """,
            agent=self.reporter,
            expected_output="åŸºäºçœŸå®æ•°æ®çš„å®Œæ•´ Markdown æ ¼å¼ç®¡ç†å±‚æŠ¥å‘Šï¼ˆå¿…é¡»åŒ…å«å®Œæ•´çš„æ•°æ®è¡¨æ ¼å’Œæ´å¯Ÿï¼‰",
            context=[task_extract_data, task_analyze_insights]  # ä¾èµ–å‰ä¸¤ä¸ªä»»åŠ¡
        )
        
        return [task_extract_data, task_analyze_insights, task_generate_report]
    
    def kickoff(self, question: str) -> str:
        """
        å¯åŠ¨åˆ†ææµç¨‹
        
        å‚æ•°:
            question: ç”¨æˆ·çš„ä¸šåŠ¡é—®é¢˜
        
        è¿”å›:
            æœ€ç»ˆçš„åˆ†ææŠ¥å‘Š
        """
        print(f"\n{'='*60}")
        print(f"ğŸš€ å¯åŠ¨æ•°æ®åˆ†æä»»åŠ¡")
        print(f"ğŸ“ é—®é¢˜: {question}")
        print(f"{'='*60}\n")
        
        # åˆ›å»ºä»»åŠ¡
        tasks = self.create_tasks(question)
        
        # åˆ›å»º Crew
        crew = Crew(
            agents=[self.data_engineer, self.biz_analyst, self.reporter],
            tasks=tasks,
            process=Process.sequential,  # é¡ºåºæ‰§è¡Œ
            verbose=True
        )
        
        # æ‰§è¡Œä»»åŠ¡
        result = crew.kickoff()
        
        print(f"\n{'='*60}")
        print(f"âœ… åˆ†æå®Œæˆï¼")
        print(f"{'='*60}\n")
        
        return result

