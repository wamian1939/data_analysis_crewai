# Prompt 修复说明 - 强制基于真实数据分析

## 🔴 问题描述

### 用户反馈的问题

用户提问："对于我这个销售额，我有什么提高消费额的方法？"

AI 返回了一份看似专业的分析报告，但**完全没有查询数据库**，内容都是编造的通用建议：

- 提到了"笔记本电脑、手机、平板电脑"
- 提到了"华东、华北地区"
- 提到了各种销售策略

但这些内容**与 SQL 数据库完全无关**，都是 AI 凭空想象的！

## ⚠️ 问题根源

### 原来的 Prompt 问题

**`crew.py` 中的任务描述太宽松：**

```python
# 任务 1：数据提取（DataEngineer）
task_extract_data = Task(
    description=f"""
    分析用户问题：{question}

    你的任务：
    1. 使用 nl2sql 工具将问题转换为 SQL 查询
    2. 使用 sql_query_md 工具执行查询
    3. 返回 Markdown 格式的数据表格

    注意：
    - 只使用 SELECT 查询
    - 确保查询准确匹配用户需求
    - 如果不确定表结构，使用 get_database_schema 工具查看
    """,
    ...
)
```

**问题：**

- ❌ 没有强制要求"必须"查询数据
- ❌ 没有禁止"凭空回答"的行为
- ❌ Agent 认为开放式问题可以不查数据直接回答

## ✅ 修复方案

### 1. 强化任务 1 的 Prompt

**新的任务描述：**

```python
task_extract_data = Task(
    description=f"""
    用户问题：{question}

    ⚠️ 重要：你必须从数据库中查询实际数据，不能凭空回答！

    你的任务（必须按顺序执行）：
    1. 首先，使用 get_database_schema() 查看数据库有哪些表和字段
    2. 然后，使用 nl2sql() 工具将问题转换为 SQL 查询
    3. 最后，使用 sql_query_md() 工具执行 SQL 查询
    4. 返回 Markdown 格式的**真实数据表格**

    ⛔ 禁止行为：
    - 不能不查询数据库就直接回答问题
    - 不能编造虚假数据
    - 不能给出没有数据支撑的通用建议

    必须返回：包含实际查询结果的 Markdown 表格
    """,
    expected_output="包含真实数据的 Markdown 格式查询结果表格（不能是空表格或编造的数据）"
)
```

**改进点：**

- ✅ 明确警告：必须查询真实数据
- ✅ 列出禁止行为
- ✅ 强制执行顺序：先查 schema → 生成 SQL → 执行查询
- ✅ expected_output 中强调"不能编造"

### 2. 强化任务 2 的 Prompt

**新的任务描述：**

```python
task_analyze_insights = Task(
    description="""
    基于上一步的**真实数据表格**，提取业务洞察。

    ⚠️ 重要：你的分析必须完全基于上一步查询到的真实数据！

    ⛔ 禁止行为：
    - 不能凭空编造洞察
    - 不能说数据表格中没有的内容
    - 洞察必须引用具体的数据（数字、比例等）

    输出格式：
    - 例如："USA 客户消费 $1,234，占比 22%"（有具体数字）
    - 不要说泛泛的通用建议
    """,
    expected_output="2-3 条基于真实数据的关键业务洞察（必须包含具体数字）"
)
```

**改进点：**

- ✅ 强调必须基于真实数据
- ✅ 要求引用具体数字
- ✅ 禁止泛泛而谈

### 3. 强化任务 3 的 Prompt

**新的任务描述：**

```python
task_generate_report = Task(
    description=f"""
    基于前两步的**真实数据和洞察**，生成一份完整的管理层报告。

    ⚠️ 重要：报告必须完全基于前两步的真实数据，不能添加任何编造的内容！

    ⛔ 禁止行为：
    - 不能删除或修改第一步的数据表格
    - 不能删除或修改第二步的洞察
    - 不能添加数据中没有的内容
    - 建议必须基于数据，不能凭空想象
    """,
    expected_output="基于真实数据的完整 Markdown 格式管理层报告（必须包含完整的数据表格和洞察）"
)
```

### 4. 更新 Agent 的 Backstory

**DataEngineer 的新 backstory：**

```python
backstory="""
你是一位严谨的数据工程师，只基于真实数据工作，绝不编造数据或凭空回答。

⚠️ 核心原则：必须查询真实数据，不能不查数据就回答问题！

⛔ 禁止行为：
- 不能不查数据库就直接回答
- 不能编造虚假数据
- 不能给出没有数据支撑的回答

你的工作流程（严格遵守）：
1. 理解用户的问题
2. 先查看数据库结构（使用 get_database_schema 或 get_csv_schema）
3. 判断应该使用哪个数据源（数据库 or CSV）
4. 使用相应的工具**实际查询数据**
5. 返回包含真实数据的 Markdown 格式表格
"""
```

## 📋 修改的文件

1. ✅ `crew.py` - 所有 3 个任务的描述
2. ✅ `agents/data_engineer.py` - Agent 的 backstory

## 🧪 测试验证

### 测试问题

```
"对于我这个销售额，我有什么提高消费额的方法？"
```

### 预期结果

**现在应该：**

1. ✅ 首先查询数据库中的实际销售数据
2. ✅ 基于查询结果给出分析
3. ✅ 报告中包含真实的数据表格
4. ✅ 洞察引用具体的数字

**不应该：**

- ❌ 不查数据就回答
- ❌ 编造虚假数据
- ❌ 给出通用建议而不引用数据

### 正确的输出示例

```markdown
# 数据分析报告

## 📋 分析问题

对于我这个销售额，我有什么提高消费额的方法？

## 📊 数据查询结果

| Country | Total | Count |
| ------- | ----- | ----- |
| USA     | $523  | 91    |
| Canada  | $303  | 56    |
| ...     | ...   | ...   |

## 💡 关键业务洞察

- USA 客户消费 $523，占总额的 22.5%，是最大市场
- Canada 排名第二，消费 $303，占 13%
- 前 3 名国家占总消费的 45%

## 🎯 建议与行动项

1. 重点投入 USA 市场，因为其贡献了 22.5% 的收入
2. 提升 Canada 客户的客单价，目前为 $5.4，低于 USA 的 $5.7
3. 开发排名 3-10 的市场，这些市场占比 35%，有增长潜力
```

## 🔧 如何使用

### 重启服务

修复后需要重启 API 服务：

```bash
# 停止当前服务 (Ctrl+C)

# 重新启动
start_all.bat
```

### 测试

```bash
# 使用 Web 界面
http://localhost:8080

# 或使用命令行
python ask_agent.py "对于我这个销售额，我有什么提高消费额的方法？"
```

### 观察日志

在 API 终端查看是否真的执行了 SQL 查询：

```
[DataEngineer] 使用工具: get_database_schema
[DataEngineer] 使用工具: nl2sql
[DataEngineer] 使用工具: sql_query_md
[DataEngineer] 执行 SQL: SELECT ...
```

如果看到这些日志，说明修复成功！

## 📝 核心改进原则

### Before (问题版本)

```
任务：分析用户问题 → 使用工具 → 返回结果
```

**问题**：Agent 可能认为不需要用工具就能回答

### After (修复版本)

```
任务：
⚠️ 必须查询真实数据！
⛔ 禁止凭空回答！
1. 先查 schema
2. 生成 SQL
3. 执行查询
4. 返回真实数据表格
```

**改进**：强制要求查询，明确禁止行为

## 🎯 总结

这次修复的核心理念：

1. **明确要求** > 隐含期望
2. **禁止行为** > 允许自由发挥
3. **强制流程** > 建议流程
4. **真实数据** > 通用建议

通过加强 Prompt 的约束力，确保 AI 始终基于真实数据进行分析，而不是凭空编造！

---

**修复日期**: 2025-01-29
**版本**: v3.1.2
