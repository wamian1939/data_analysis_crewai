# 调试指南 - 问题排查

## 问题：提问后只显示元信息，没有数据内容

### 症状

```
AI
查询ID: q_20251029_180347_7937b7
执行时间: 50.70s
状态: success
```

只显示查询 ID、执行时间和状态，但没有数据、洞察、SQL 等内容。

---

## 解决方案

### 步骤 1：查看浏览器控制台

1. 打开浏览器（推荐 Chrome）
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` 标签
4. 刷新页面并重新提问
5. 查看控制台输出的 `Result data:` 信息

**示例输出**：

```javascript
Result data: {
  query_id: "q_20251029_180347_7937b7",
  question: "哪个国家的客户消费最多？",
  status: "success",
  data: [...],          // 应该有内容
  insights: [...],      // 应该有内容
  report: "...",        // 应该有内容
  executed_sql: "...",  // 应该有内容
  execution_time: 50.7
}
```

### 步骤 2：检查后端日志

打开运行 API 的终端窗口，查看输出：

```
[AnalysisService] 开始分析: 哪个国家的客户消费最多？
[AnalysisService] 解析结果类型: <class 'str'>
[AnalysisService] 提取结果 - data: 10 行, insights: 3 条, sql: 有
[AnalysisService] 分析完成，耗时: 50.70秒
```

---

## 常见问题和解决方法

### 问题 1：`data`、`insights`、`sql` 都是空的

**原因**：CrewAI 返回的报告格式不符合预期，提取逻辑失败。

**解决方法 1**：查看完整报告

- 前端已经添加了兜底逻辑
- 如果结构化数据为空，会显示原始 `report` 内容
- 刷新页面重新提问即可看到完整报告

**解决方法 2**：检查 CrewAI 输出格式

```bash
# 查看后端输出的完整报告
# 在 API 日志中查找报告内容
```

### 问题 2：浏览器控制台报错

**常见错误**：

```
TypeError: Cannot read property 'length' of undefined
```

**解决方法**：

- 清除浏览器缓存
- 强制刷新页面 (`Ctrl+F5`)
- 检查 API 服务是否正常运行

### 问题 3：API 返回 500 错误

**检查**：

```bash
# 查看 API 终端的错误信息
# 可能是数据库连接问题或 Agent 执行错误
```

**解决方法**：

1. 检查 `config.py` 配置是否正确
2. 检查数据库是否正常运行
3. 检查 OpenAI API Key 是否有效

---

## 快速修复步骤

### 1. 更新前端代码（已完成）

`web/app.js` 已经更新，添加了：

- ✅ 调试日志输出
- ✅ 完整报告显示（兜底方案）
- ✅ 更好的错误处理

### 2. 更新后端代码（已完成）

`api/services.py` 已经更新，添加了：

- ✅ 结果类型日志
- ✅ 提取结果统计
- ✅ 详细的调试信息

### 3. 重启服务

```bash
# 停止当前运行的服务（Ctrl+C）

# 重新启动
start_all.bat
```

### 4. 测试

1. 打开 http://localhost:8080
2. 按 `F12` 打开控制台
3. 提问："哪个国家的客户消费最多？"
4. 查看控制台的 `Result data:` 输出
5. 查看 API 终端的日志输出

---

## 预期结果

### 正常情况下应该看到：

**前端显示**：

```
AI

关键洞察
- USA 客户消费最高，占比 22%
- 第二名是 Canada，占比 12%
- 前三名占据总消费的 50%

数据结果
| Country | Total | Percentage |
|---------|-------|------------|
| USA     | $1234 | 22%       |
| Canada  | $567  | 12%       |
...

SQL 查询
SELECT Country, SUM(Total) as Total, ...

查询ID: q_20251029_180347_7937b7
执行时间: 50.70s
状态: success
```

**控制台输出**：

```javascript
Result data: {
  query_id: "q_20251029_180347_7937b7",
  data: [{Country: "USA", Total: 1234, Percentage: "22%"}, ...],
  insights: ["USA 客户消费最高，占比 22%", ...],
  executed_sql: "SELECT Country, ...",
  report: "# 数据分析报告\n\n...",
  execution_time: 50.7,
  status: "success"
}
```

---

## 如果还是不行

### 方案 1：使用命令行工具测试

```bash
python ask_agent.py "哪个国家的客户消费最多？"
```

这样可以直接看到后端返回的完整内容。

### 方案 2：直接调用 API 测试

```bash
curl -X POST "http://localhost:8000/api/v1/analyze" \
  -H "Content-Type: application/json" \
  -d '{"question": "哪个国家的客户消费最多？"}'
```

查看 API 返回的 JSON 内容。

### 方案 3：查看示例报告

```bash
# 查看 report/output 目录下的示例报告
# 这些是之前成功生成的报告
```

---

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. **浏览器控制台截图**（按 F12，Console 标签）
2. **API 终端日志**（完整的输出）
3. **问题描述**（什么问题、什么时候发生）
4. **测试问题**（具体提的是什么问题）

---

**最后更新**: 2025-01-29
**版本**: v3.1.1
