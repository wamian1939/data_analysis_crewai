# 连续对话功能使用说明

## 功能概述

CrewAI 数据分析系统现在支持**连续对话**功能，AI 可以理解对话上下文，支持多轮问答。

## 主要特性

### 1. 上下文记忆

- 系统会记住最近 3 轮对话（6 条消息）
- AI 可以理解代词引用（"它"、"这个"、"那个"等）
- 支持追问和深入分析

### 2. 会话管理

- **新对话按钮**：清空对话历史，开始全新对话
- **快捷键**：`Ctrl+N` 或 `Cmd+N` 快速开始新对话
- **消息计数**：侧边栏显示当前对话的消息数量
- **自动保存**：对话历史自动保存到浏览器（保留 24 小时）

### 3. 智能理解

后端 AI 会自动整合对话历史，理解完整的语境。

## 使用示例

### 示例 1：逐步深入分析

```
用户: 哪个国家的客户消费最多？
AI: [显示 USA 客户消费最高的数据]

用户: 那它的平均客单价是多少？
AI: [理解"它"指的是 USA，计算平均客单价]

用户: 和第二名相比呢？
AI: [对比 USA 和第二名国家的数据]
```

### 示例 2：追问细节

```
用户: 收入最高的艺人 TOP 10？
AI: [显示 TOP 10 艺人列表]

用户: 第一名有多少首歌？
AI: [理解指的是 TOP 1 艺人，查询歌曲数量]

用户: 这些歌属于哪些流派？
AI: [分析该艺人的音乐流派分布]
```

### 示例 3：对比分析

```
用户: 2023 年的销售总额？
AI: [显示 2023 年销售数据]

用户: 和 2022 年相比增长了多少？
AI: [对比 2022 和 2023 年数据，计算增长率]
```

## 技术实现

### 前端

- 使用 JavaScript 数组存储对话历史
- 每次请求时将历史发送到后端
- 使用 localStorage 持久化对话

### 后端

- 接收对话历史参数
- 构建包含上下文的完整问题
- 只保留最近 3 轮对话（避免 token 过多）
- 自动简化历史内容（只保留关键信息）

### API 请求格式

```json
{
  "question": "那它的平均客单价是多少？",
  "user_id": "web_user",
  "save_result": true,
  "conversation_history": [
    {
      "role": "user",
      "content": "哪个国家的客户消费最多？"
    },
    {
      "role": "assistant",
      "content": "USA 客户消费最高，总消费额为 $1,234,567"
    }
  ]
}
```

## 最佳实践

### 1. 清晰的追问

**好的追问**：

- "它的平均值是多少？"
- "和去年相比呢？"
- "前三名的总和是多少？"

**不好的追问**：

- "再来一个"（含义不明）
- "换个方式"（没有具体指示）

### 2. 适时开始新对话

以下情况建议开始新对话：

- 切换到完全不同的分析主题
- 对话轮数超过 5-6 轮（避免上下文混乱）
- 需要全新的分析视角

### 3. 利用快捷键

- `Enter`：发送消息
- `Shift+Enter`：换行
- `Ctrl+N`：新对话

## 注意事项

### 1. 对话历史限制

- 只保留最近 3 轮对话作为上下文
- 超过部分会被自动丢弃
- 每条消息限制 200 字符（用于上下文）

### 2. 浏览器存储

- 对话自动保存到 localStorage
- 保留时间：24 小时
- 清除浏览器缓存会丢失对话历史

### 3. 性能考虑

- 上下文越长，AI 处理时间越久
- 建议定期开始新对话
- 复杂查询可能需要 30-60 秒

## 常见问题

### Q: 对话历史会保存到服务器吗？

A: 不会。对话历史只保存在浏览器的 localStorage 中，不会上传到服务器。

### Q: 刷新页面会丢失对话吗？

A: 不会。24 小时内刷新页面，对话历史会自动恢复（但 UI 不会显示之前的消息）。

### Q: AI 能记住多久之前的对话？

A: AI 只能记住当前会话中最近 3 轮对话。点击"新对话"会清空所有记忆。

### Q: 如何完全清除对话历史？

A: 点击"新对话"按钮（或按 `Ctrl+N`），或清除浏览器的 localStorage。

## 开发者信息

### 相关文件

- **前端**：`web/app.js` - 对话历史管理
- **后端**：`api/services.py` - 上下文处理
- **模型**：`api/models.py` - 数据模型定义

### 自定义配置

在 `api/services.py` 中修改：

```python
# 保留的对话轮数（当前为 3 轮）
recent_history = conversation_history[-6:]  # 3轮 = 6条消息

# 每条消息的最大长度（当前为 200 字符）
if len(content) > 200:
    content = content[:200] + "..."
```

## 更新日志

**v3.1.0**

- 新增连续对话功能
- 支持上下文记忆（3 轮）
- 添加会话管理和消息计数
- 实现自动保存和恢复
- 添加快捷键支持

---

**使用愉快！有任何问题请参考 README.md 或查看源代码。**
